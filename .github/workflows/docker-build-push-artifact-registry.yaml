name: Docker Build & Push to Docker Hub
on:
  push:
    branches: [dev, qa, prod]
    tags: ['*']
  workflow_dispatch:
env:
  IMAGE_NAME: acute
  # OCI Object Storage for Maven M2 dependencies (optional). Set vars: OCI_BUCKET_NAMESPACE, OCI_BUCKET_NAME; optional OCI_M2_PREFIX. Secrets: OCI_CLI_CONFIG, OCI_CLI_KEY. Set USE_OCI_M2=true to enable.
  OCI_BUCKET_NAMESPACE: ${{ vars.OCI_BUCKET_NAMESPACE || '' }}
  OCI_BUCKET_NAME: ${{ vars.OCI_BUCKET_NAME || '' }}
  OCI_M2_PREFIX: ${{ vars.OCI_M2_PREFIX || '' }}
  USE_OCI_M2: ${{ vars.USE_OCI_M2 || 'false' }}
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - name: Validate config
        run: |
          if [ -z "${{ env.DOCKERHUB_USERNAME }}" ]; then echo "::error::Set DOCKERHUB_USERNAME in repo Variables"; exit 1; fi
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then echo "::error::Set DOCKERHUB_TOKEN in repo Secrets"; exit 1; fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare m2-repo
        run: mkdir -p m2-repo

      - name: Restore OCI CLI cache
        if: env.USE_OCI_M2 == 'true'
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/bin
            ~/.local
          key: oci-cli-${{ runner.os }}-1

      - name: Download M2 dependencies from OCI
        if: env.USE_OCI_M2 == 'true'
        env:
          OCI_CLI_CONFIG: ${{ secrets.OCI_CLI_CONFIG }}
          OCI_CLI_KEY: ${{ secrets.OCI_CLI_KEY }}
        run: |
          if [ -z "$OCI_CLI_CONFIG" ] || [ -z "$OCI_CLI_KEY" ]; then
            echo "::error::USE_OCI_M2 is true but OCI_CLI_CONFIG or OCI_CLI_KEY secret is missing"
            exit 1
          fi
          if [ -z "${{ env.OCI_BUCKET_NAMESPACE }}" ] || [ -z "${{ env.OCI_BUCKET_NAME }}" ]; then
            echo "::error::Set OCI_BUCKET_NAMESPACE and OCI_BUCKET_NAME in repo Variables when USE_OCI_M2 is true"
            exit 1
          fi
          mkdir -p ~/.oci
          echo "$OCI_CLI_CONFIG" > ~/.oci/config
          echo "$OCI_CLI_KEY" > ~/.oci/key.pem
          chmod 600 ~/.oci/config ~/.oci/key.pem
          export PATH="$HOME/bin:$PATH"
          if ! command -v oci >/dev/null 2>&1; then
            bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
          fi
          oci os object list --namespace "${{ env.OCI_BUCKET_NAMESPACE }}" --bucket-name "${{ env.OCI_BUCKET_NAME }}" --limit 1
          PREFIX="${{ env.OCI_M2_PREFIX }}"
          if [ -n "$PREFIX" ]; then
            oci os object bulk-download --namespace "${{ env.OCI_BUCKET_NAMESPACE }}" --bucket-name "${{ env.OCI_BUCKET_NAME }}" --prefix "$PREFIX" --download-dir ./m2-repo
          else
            oci os object bulk-download --namespace "${{ env.OCI_BUCKET_NAMESPACE }}" --bucket-name "${{ env.OCI_BUCKET_NAME }}" --download-dir ./m2-repo
          fi

      - name: Save OCI CLI cache
        if: env.USE_OCI_M2 == 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/bin
            ~/.local
          key: oci-cli-${{ runner.os }}-1

      - name: Set Docker tag (branch vs tag)
        id: set_tag
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "DOCKER_TAG=${{ github.ref_name }}-$SHORT_SHA" >> $GITHUB_ENV
          else
            YYMMDDHH=$(date +%y%m%d%H)
            echo "DOCKER_TAG=${{ github.ref_name }}-${YYMMDDHH}-${SHORT_SHA}-${{ github.run_number }}" >> $GITHUB_ENV
          fi
          echo "tag=${{ env.DOCKER_TAG }}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (tags & labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ env.DOCKER_TAG }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: false
          cache-from: type=gha,scope=build
          cache-to: type=gha,mode=max,scope=build

  notify-teams:
    needs: build-and-push
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Microsoft Teams
        continue-on-error: true
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          TAG: ${{ needs.build-and-push.outputs.docker_tag }}
          DOCKERHUB_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          if [ -z "$TEAMS_WEBHOOK_URL" ]; then
            echo "TEAMS_WEBHOOK_URL not set, skipping notification"
            exit 0
          fi
          STATUS="${{ needs.build-and-push.result }}"
          [ "$STATUS" = "success" ] && THEME="0076D7" || THEME="D13438"
          [ -z "$TAG" ] && IMAGE_TAG="${DOCKERHUB_USERNAME}/${IMAGE_NAME}:(build did not complete)" || IMAGE_TAG="${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${TAG}"
          BODY=$(cat <<EOF
          {
            "@type": "MessageCard",
            "@context": "https://schema.org/extensions",
            "themeColor": "${THEME}",
            "summary": "Docker Build & Push - ${STATUS}",
            "sections": [{
              "activityTitle": "Docker Build & Push to Docker Hub",
              "activitySubtitle": "${{ github.repository }}",
              "facts": [
                { "name": "Status", "value": "${STATUS}" },
                { "name": "Ref", "value": "${{ github.ref_name }}" },
                { "name": "Commit", "value": "${{ github.sha }}" },
                { "name": "Image", "value": "${IMAGE_TAG}" },
                { "name": "Run", "value": "[View workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" }
              ]
            }]
          }
          EOF
          )
          curl -sS -X POST -H "Content-Type: application/json" -d "${BODY}" "$TEAMS_WEBHOOK_URL"
